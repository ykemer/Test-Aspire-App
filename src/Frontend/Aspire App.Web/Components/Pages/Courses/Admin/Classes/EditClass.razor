@page "/admin/courses/{courseId:guid}/classes/{classId:guid}"
@using Aspire_App.Web.Exceptions
@using Aspire_App.Web.Helpers
@using Aspire_App.Web.Services.Courses
@using Contracts.Courses.Requests
@using Contracts.Courses.Responses
@rendermode InteractiveServer

@inject ICoursesApiService CoursesApiService
@inject IClassesApiService ClassesApiService
@inject NavigationManager NavigationManager;

<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          @if (_course is not null && updateClassForm is not null)
          {
            <h3 class="card-title mb-3">Edit class for @_course.Name</h3>
          }

          @if (loading)
          {
            <div class="d-flex justify-content-center align-items-center py-5">
              <div class="spinner-border text-primary" role="status" aria-label="Loading class"></div>
              <span class="ms-2 text-muted">Loading class...</span>
            </div>
          }
          else
          {
            @if (_successMessage is not null)
            {
              <div class="alert alert-success" role="alert">@_successMessage</div>
            }

            @if (_errorMessage is not null)
            {
              <div class="alert alert-danger" role="alert">@_errorMessage</div>
            }

            <EditForm EditContext="_editContext" OnValidSubmit="SubmitAsync" FormName="updateClassForm">
              <DataAnnotationsValidator/>
              <ValidationSummary/>

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="RegistrationDeadline" class="form-label">Registration Deadline</label>
                  <InputDate id="RegistrationDeadline" class="form-control" @bind-Value="updateClassForm.RegistrationDeadline"/>
                  <ValidationMessage For="@(() => updateClassForm.RegistrationDeadline)"/>
                </div>
                <div class="col-md-6">
                  <label for="CourseStartDate" class="form-label">Start Date</label>
                  <InputDate id="CourseStartDate" class="form-control" @bind-Value="updateClassForm.CourseStartDate"/>
                  <ValidationMessage For="@(() => updateClassForm.CourseStartDate)"/>
                </div>
                <div class="col-md-6">
                  <label for="CourseEndDate" class="form-label">End Date</label>
                  <InputDate id="CourseEndDate" class="form-control" @bind-Value="updateClassForm.CourseEndDate"/>
                  <ValidationMessage For="@(() => updateClassForm.CourseEndDate)"/>
                </div>
                <div class="col-md-6">
                  <label for="MaxStudents" class="form-label">Max Students</label>
                  <InputNumber id="MaxStudents" class="form-control" @bind-Value="updateClassForm.MaxStudents"/>
                  <ValidationMessage For="@(() => updateClassForm.MaxStudents)"/>
                </div>
              </div>

              <button type="submit" class="btn btn-primary mt-4">Update</button>
            </EditForm>
          }
        </div>
      </div>
    </div>
  </div>
</div>

@if (_successMessage is not null)
{
  <!-- success already shown above inside card -->
}

@if (_errorMessage is not null)
{
  <!-- error already shown above inside card -->
}

@code {
  [Parameter] public Guid CourseId { get; set; }
  [Parameter] public Guid ClassId { get; set; }

  private CourseResponse? _course;
  public UpdateClassRequest updateClassForm;
  private EditContext _editContext;
  private ValidationMessageStore _messageStore;

  private string? _errorMessage;
  private string? _successMessage;
  private bool loading = true;
  private bool _redirectTo404;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      var course = await CoursesApiService.GetCourse(CourseId);
      var existingClass = await ClassesApiService.GetClass(CourseId, ClassId);
      _course = course;
      updateClassForm = new UpdateClassRequest
      {
        RegistrationDeadline = existingClass.RegistrationDeadline.ToLocalTime(),
        CourseStartDate = existingClass.CourseStartDate.ToLocalTime(),
        CourseEndDate = existingClass.CourseEndDate.ToLocalTime(),
        MaxStudents = existingClass.MaxStudents
      };
      _editContext = new EditContext(updateClassForm);
      _messageStore = new ValidationMessageStore(_editContext);
      _editContext.OnFieldChanged += EditContext_OnFieldChanged;
      loading = false;
    }
    catch
    {
      _redirectTo404 = true;
    }
  }

  protected override Task OnAfterRenderAsync(bool firstRender)
  {
    if (_redirectTo404)
    {
      _redirectTo404 = false;
      NavigationManager.NavigateTo("/404", replace: true);
    }
    if (firstRender) StateHasChanged();
    return Task.CompletedTask;
  }


  private async Task SubmitAsync()
  {
    try
    {
      await ClassesApiService.UpdateClass(CourseId, ClassId, updateClassForm);
      _errorMessage = null;
      _successMessage = "Course updated successfully!";
      NavigationManager.NavigateTo($"/admin/courses/{CourseId}/classes");
    }
    catch (ValidationException ex)
    {
      _messageStore.Clear();

      foreach (var error in ex.Errors)
      {
        var fieldIdentifier = new FieldIdentifier(updateClassForm, FrontendHelper.ToPascalCase(error.Key));
        _messageStore.Add(fieldIdentifier, error.Value);
      }

      _editContext.NotifyValidationStateChanged();
    }
    catch (Exception ex)
    {
      _successMessage = null;
      _errorMessage = ex.Message;
    }
  }


  private void EditContext_OnFieldChanged(object? sender, FieldChangedEventArgs e)
  {
    _messageStore.Clear(e.FieldIdentifier);
    _editContext.NotifyValidationStateChanged();
  }

  public void Dispose()
  {
    _editContext.OnFieldChanged -= EditContext_OnFieldChanged;
  }

}
